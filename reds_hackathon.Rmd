---
title: "reds_hackathon"
author: "Harrison Cradduck"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#read in packages
library(tidyverse)
library(dplyr)
library(caret)
library(car)
library(ggfortify)
library(MASS)
library(kableExtra)
```

```{r}
#set working directory
setwd("C:\\Users\\harri\\Downloads")
```

```{r}
#read in data
lahman_people_data <- read.csv("lahman_people.csv", header=TRUE)
savant_pitch_by_pitch <- read.csv("savant_data_2021_2023.csv", header=TRUE)
```

```{r}
#view datasets
head(lahman_people_data)
head(savant_pitch_by_pitch)
```

```{r}
#wrangle lahman data
lahmanPeopleData <- lahman_people_data %>%
  mutate(debutYear = substr(debut, 1, 4),
         throws = as.factor(throws),
         bats = as.factor(bats),
         birthCountry = as.factor(birthCountry),
         debutYear = as.numeric(debutYear)) %>%
  dplyr::select(-birthMonth, -birthDay, -birthDate, -debut, -playerID_LAHMAN) %>%
  rename(playerMLBID = player_mlb_id) %>%
  filter(playerMLBID != "")
head(lahmanPeopleData)
#number of observations with no playerMLBID
# sum(lahmanPeopleData$playerMLBID == "")
```

```{r}
#columns/variables to average for batters
columnsToAvgBatter <- c("hit_distance_sc", "launch_speed", "launch_angle", "strikes", "hc_x", "hc_y", "estimated_ba_using_speedangle", "estimated_woba_using_speedangle", "woba_value", "woba_denom", "babip_value", "iso_value")
```

```{r}
#calculate totals and averages for batters by year
plateAppearancesByYear <- 
    savant_pitch_by_pitch %>%
    group_by(
        batter,
        game_year,
        game_pk,
        at_bat_number
    ) %>%
    summarise(
        stand = first(stand),
        across(all_of(columnsToAvgBatter), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}")
    ) %>%
    ungroup() %>%
    group_by(
        batter,
        game_year
    ) %>%
    summarise(
        atBats = n(),
        stand = first(stand),
        across(starts_with("avg_"), ~ mean(.x, na.rm = TRUE))
    ) %>%
    ungroup()
```

```{r}
head(plateAppearancesByYear)
```

```{r}
#data frame with batters' totals and averages over last three years combined
plateAppearancesTotal <- 
    plateAppearancesByYear %>%
    group_by(batter) %>%
    summarise(
        #totalAtBats = sum(atBats, na.rm = TRUE),
        avgAtBats = mean(atBats),
        stand = first(stand),
        totalYearsPlayed = n_distinct(game_year),
        across(starts_with("avg_"), ~ weighted.mean(.x, atBats, na.rm = TRUE), .names = "weighted_{.col}")
    ) %>%
    ungroup()
head(plateAppearancesTotal)
```

```{r}
#combine selected savant and lahman data for batters
plateAppearancesTotal <- plateAppearancesTotal %>%
    left_join(lahmanPeopleData, by = c("batter" = "playerMLBID")) %>%
    dplyr::select(-throws)
head(plateAppearancesTotal)
```

```{r}
#first look at regression for batters' playing time
#glimpse(plateAppearancesTotal)
plateAppearancesTotalFiltered <- plateAppearancesTotal %>%
  dplyr::select(-batter, -birthCountry) %>%
  mutate(stand = as.factor(stand))
battersReg1 <- lm(avgAtBats ~ ., data=plateAppearancesTotalFiltered)
summary(battersReg1)
```

```{r}
#first look at RMSE from this batters regression 1
#line below changes NA values to 0 (as of now, this increases RMSE by ~10)
#plateAppearancesTotalFiltered[is.na(plateAppearancesTotalFiltered)] <- 0
obs <- plateAppearancesTotalFiltered$avgAtBats
pred <- predict(battersReg1, plateAppearancesTotalFiltered)
battersRMSE <- RMSE(pred, obs, na.rm=TRUE)
battersRMSE
```

```{r}
#remove predictors by highest VIF
battersReg2 <- lm(avgAtBats ~ . - weighted_avg_estimated_woba_using_speedangle - bats - weighted_avg_woba_value - weighted_avg_hc_y - birthYear - weighted_avg_hit_distance_sc, data=plateAppearancesTotalFiltered) #weighted_avg_woba_value is sig
summary(battersReg2)
vif(battersReg2)
# battersReg3 <- lm(avgAtBats ~ . - weighted_avg_estimated_woba_using_speedangle - bats - weighted_avg_woba_value - weighted_avg_hc_y - birthYear, data=plateAppearancesTotalFiltered)
# anova(battersReg2, battersReg3)
```

**has all VIFs under 2.1**

```{r}
#remove insignificant predictors
battersReg3 <- lm(avgAtBats ~ . - weighted_avg_estimated_woba_using_speedangle - bats - weighted_avg_woba_value - weighted_avg_hc_y - birthYear - weighted_avg_hit_distance_sc - height - weighted_avg_hc_x - weighted_avg_launch_angle - weighted_avg_estimated_ba_using_speedangle - weighted_avg_woba_denom - weight - stand, data=plateAppearancesTotalFiltered) #weighted_avg_woba_value was sig
summary(battersReg3)
obs <- plateAppearancesTotalFiltered$avgAtBats
pred <- predict(battersReg3, plateAppearancesTotalFiltered)
battersRMSE <- RMSE(pred, obs, na.rm=TRUE)
battersRMSE
```

**builds on battersReg2 and has only all significant predictors (6 total)**

```{r}
autoplot(battersReg3)
crPlots(battersReg3)
boxcox(battersReg3)
#0.3 power trans. of response as suggested by boxcox
battersReg4 <- lm(I((avgAtBats^0.3 - 1)/0.3) ~ . - weighted_avg_estimated_woba_using_speedangle - bats - weighted_avg_woba_value - weighted_avg_hc_y - birthYear - weighted_avg_hit_distance_sc - height - weighted_avg_hc_x - weighted_avg_launch_angle - weighted_avg_estimated_ba_using_speedangle - weighted_avg_woba_denom - weight - stand, data=plateAppearancesTotalFiltered) 
summary(battersReg4)
autoplot(battersReg4)
obs <- plateAppearancesTotalFiltered$avgAtBats
pred <- predict(battersReg4, plateAppearancesTotalFiltered)
battersRMSE <- RMSE(pred, obs, na.rm=TRUE)
battersRMSE
```

**0.3 power trans. on playing time -> adjusted R^2 goes up by 9%, RMSE goes up by 127**

```{r}
#trying some basic model selection with all the variables for batters
#remove all rows with NAs to match regression and dataset
plateAppearancesTotalFilteredNoNA <- na.omit(plateAppearancesTotalFiltered)
battersReg5 <- lm(avgAtBats ~ ., data=plateAppearancesTotalFilteredNoNA)
null <- lm(avgAtBats ~ 1, data=plateAppearancesTotalFilteredNoNA)
forwardAIC <- step(null, direction="forward", scope=list(upper=battersReg5))
backwardAIC <- step(battersReg5, direction="backward")
n <- dim(plateAppearancesTotalFilteredNoNA)[1]
forwardBIC <- step(null, direction="forward", scope=list(upper=battersReg5),k=log(n))
backwardBIC <- step(battersReg5, direction="backward",k=log(n))
model_summary <- data.frame(
  Method = c(
    "Forward Elimination (AIC)", 
    "Backward Elimination (AIC)", 
    "Forward Elimination (BIC)", 
    "Backward Elimination (BIC)"
  ),
  Variables_Selected = c(
    paste(names(coef(forwardAIC))[-1], collapse = ", "),
    paste(names(coef(backwardAIC))[-1], collapse = ", "),
    paste(names(coef(forwardBIC))[-1], collapse = ", "),
    paste(names(coef(backwardBIC))[-1], collapse = ", ")
  ),
  AIC = c(
    AIC(forwardAIC), AIC(backwardAIC), AIC(forwardBIC), AIC(backwardBIC)
  ),
  BIC = c(
    BIC(forwardAIC), BIC(backwardAIC), BIC(forwardBIC), BIC(backwardBIC)
  )
)

# Create HTML table
model_summary %>%
  kable("html", caption = "Summary of Variable Selection Methods and Results") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(2, width = "40em")  # Adjust width for the Variables_Selected column
```




```{r}
#columns/variables to average for pitchers
columnsToAvgPitcher <- c("release_speed", "release_pos_x", "release_pos_y", "balls", "strikes", "pfx_x", "pfx_z", "vx0", "vy0", "vz0", "ax", "ay", "az", "effective_speed", "release_spin_rate", "release_extension", "spin_axis")
```

```{r}
#slimmer data table to make processing easier
savant_pitch_by_pitch2 <- savant_pitch_by_pitch %>%
  select(-pitch_type, -game_date, -game_type, -events, -description, -home_team, -away_team, -type, -hit_location, -bb_type, -on_3b, -on_2b, -on_1b, -fielder_2, -fielder_2_1, -fielder_3, -fielder_4, -fielder_5, -fielder_6, -fielder_7, -fielder_8, -fielder_9, -pitcher_1, -if_fielding_alignment, -of_fielding_alignment, -bat_score, -fld_score, -post_away_score, -post_home_score, -post_bat_score, -post_fld_score)
```

```{r}
#calculate totals and averages for pitchers by year
battersFacedByYear <- 
    savant_pitch_by_pitch %>%
    #slice(1:1000) %>% #uses only first 1000 obs of data
    group_by(
        pitcher,
        game_year,
        game_pk,
        at_bat_number
    ) %>%
    summarise(
        sp_indicator = first(sp_indicator),
        rp_indicator = first(rp_indicator),
        throws = first(p_throws),
        across(all_of(columnsToAvgPitcher), ~ mean(.x, na.rm = TRUE), .names = "avg_{.col}")
    ) %>%
    ungroup() %>%
    group_by(
        pitcher,
        game_year,
        game_pk
    ) %>%
    summarise(
        throws = first(throws),
        game_start = max(sp_indicator, na.rm = TRUE),
        game_relief = max(rp_indicator, na.rm = TRUE),
        battersFacedAsStarter = sum(sp_indicator, na.rm = TRUE),
        battersFacedAsReliever = sum(rp_indicator, na.rm = TRUE),
        across(starts_with("avg_"), ~ mean(.x, na.rm = TRUE))
    ) %>%
    ungroup() %>%
    group_by(
        pitcher,
        game_year
    ) %>%
    summarise(
        atBatsFaced = sum(battersFacedAsStarter + battersFacedAsReliever),
        throws = first(throws),
        starts = sum(game_start, na.rm = TRUE),
        reliefs = sum(game_relief, na.rm = TRUE),
        battersFacedAsStarter = sum(battersFacedAsStarter, na.rm = TRUE),
        battersFacedAsReliever = sum(battersFacedAsReliever, na.rm = TRUE),
        across(starts_with("avg_"), ~ mean(.x, na.rm = TRUE))
    ) %>%
    ungroup()
```

```{r}
head(battersFacedByYear)
```

```{r}
#data frame with pitchers' totals and averages over last three years combined
battersFacedTotal <- 
    battersFacedByYear %>%
    group_by(pitcher) %>%
    summarise(
        totalAtBatsFaced = sum(atBatsFaced, na.rm = TRUE),
        avgAtBatsFaced = mean(atBatsFaced, na.rm = TRUE),
        totalStarts = sum(starts, na.rm = TRUE),
        totalReliefs = sum(reliefs, na.rm = TRUE),
        totalBattersFacedAsStarter = sum(battersFacedAsStarter, na.rm = TRUE),
        totalBattersFacedAsReliever = sum(battersFacedAsReliever, na.rm = TRUE),
        totalYearsPlayed = n_distinct(game_year),
        across(starts_with("avg_"), ~ weighted.mean(.x, w = atBatsFaced, na.rm = TRUE), .names = "weighted_{.col}")
    ) %>%
    ungroup()
```

```{r}
#combine selected savant and lahman data for pitchers
battersFacedTotal <- battersFacedTotal %>%
    left_join(lahmanPeopleData, by = c("pitcher" = "playerMLBID")) %>%
    dplyr::select(-bats)
head(battersFacedTotal)
```

```{r}
#first look at regression for pitchers' playing time
#glimpse(battersFacedTotal)
battersFacedTotalFiltered <- battersFacedTotal %>%
  dplyr::select(-pitcher, -totalAtBatsFaced, -birthCountry)
pitchersReg1 <- lm(avgAtBatsFaced ~ ., data=battersFacedTotalFiltered)
summary(pitchersReg1)
```

```{r}
#first look at RMSE from this pitchers regression 1
#line below changes NA values to 0 (as of now, this increases RMSE by ~10)
#battersFacedTotallFiltered[is.na(battersFacedTotallFiltered)] <- 0
obs <- battersFacedTotalFiltered$avgAtBatsFaced
pred <- predict(pitchersReg1, battersFacedTotalFiltered)
pitchersRMSE <- RMSE(pred, obs, na.rm=TRUE)
pitchersRMSE
```

##Ideas
###need to use autoplot to assess normality, linearity, constant variance
###make sure to check crPlots for transformations on individual predictors
###need to limit predictors to less than 7 ideally
###do this by checking significance, VIFs, and then model selection using best subset/AIC/BIC/PRESS/adj R^2

```{r}
#remove predictors by highest VIF
pitchersReg2 <- lm(avgAtBatsFaced ~ . - weighted_avg_release_speed - weighted_avg_release_extension - weighted_avg_vy0 - totalBattersFacedAsStarter - weighted_avg_vx0 - weighted_avg_ax - weighted_avg_effective_speed - weighted_avg_az - totalReliefs - throws - weighted_avg_ay - debutYear - weighted_avg_pfx_x, data=battersFacedTotalFiltered)
summary(pitchersReg2)
vif(pitchersReg2)
# pitchersReg3 <- lm(avgAtBatsFaced ~ . - weighted_avg_release_speed - weighted_avg_release_extension - weighted_avg_vy0 - totalBattersFacedAsStarter - weighted_avg_vx0 - weighted_avg_ax - weighted_avg_effective_speed - weighted_avg_az - totalReliefs, data=battersFacedTotalFiltered)
# summary(pitchersReg3)
# vif(pitchersReg3)
# anova(pitchersReg2, pitchersReg3)
```

**has all VIFs under 3**

```{r}
#remove insignificant predictors
pitchersReg3 <- lm(avgAtBatsFaced ~ . - weighted_avg_release_speed - weighted_avg_release_extension - weighted_avg_vy0 - totalBattersFacedAsStarter - weighted_avg_vx0 - weighted_avg_ax - weighted_avg_effective_speed - weighted_avg_az - totalReliefs - throws - weighted_avg_ay - debutYear - weighted_avg_pfx_x - height - weighted_avg_release_spin_rate - weighted_avg_release_pos_x - weighted_avg_spin_axis - birthYear, data=battersFacedTotalFiltered)
summary(pitchersReg3)
obs <- battersFacedTotalFiltered$avgAtBatsFaced
pred <- predict(pitchersReg3, battersFacedTotalFiltered)
pitchersRMSE <- RMSE(pred, obs, na.rm=TRUE)
pitchersRMSE
```

**builds on pitchersReg2 and has only all significant predictors (9 total)**

```{r}
autoplot(pitchersReg3)
crPlots(pitchersReg3)
boxcox(pitchersReg3)
#sqrt trans. of response as suggested by boxcox
pitchersReg4 <- lm(sqrt(avgAtBatsFaced) ~ . - weighted_avg_release_speed - weighted_avg_release_extension - weighted_avg_vy0 - totalBattersFacedAsStarter - weighted_avg_vx0 - weighted_avg_ax - weighted_avg_effective_speed - weighted_avg_az - totalReliefs - throws - weighted_avg_ay - debutYear - weighted_avg_pfx_x - height - weighted_avg_release_spin_rate - weighted_avg_release_pos_x - weighted_avg_spin_axis - birthYear, data=battersFacedTotalFiltered)
summary(pitchersReg4)
obs <- battersFacedTotalFiltered$avgAtBatsFaced
pred <- predict(pitchersReg4, battersFacedTotalFiltered)
pitchersRMSE <- RMSE(pred, obs, na.rm=TRUE)
pitchersRMSE
```

**sqrt trans. on playing time -> adjusted R^2 goes down by 6%, RMSE goes up by 190**

```{r}
#trying some basic model selection with all the variables for pitchers
#remove all rows with NAs to match regression and dataset
battersFacedTotalFilteredNoNA <- na.omit(battersFacedTotalFiltered)
pitchersReg5 <- lm(avgAtBatsFaced ~ ., data=battersFacedTotalFilteredNoNA)
null <- lm(avgAtBatsFaced ~ 1, data=battersFacedTotalFilteredNoNA)
forwardAIC <- step(null, direction="forward", scope=list(upper=pitchersReg5))
backwardAIC <- step(pitchersReg5, direction="backward")
n <- dim(battersFacedTotalFilteredNoNA)[1]
forwardBIC <- step(null, direction="forward", scope=list(upper=pitchersReg5),k=log(n))
backwardBIC <- step(pitchersReg5, direction="backward",k=log(n))
model_summary <- data.frame(
  Method = c(
    "Forward Elimination (AIC)", 
    "Backward Elimination (AIC)", 
    "Forward Elimination (BIC)", 
    "Backward Elimination (BIC)"
  ),
  Variables_Selected = c(
    paste(names(coef(forwardAIC))[-1], collapse = ", "),
    paste(names(coef(backwardAIC))[-1], collapse = ", "),
    paste(names(coef(forwardBIC))[-1], collapse = ", "),
    paste(names(coef(backwardBIC))[-1], collapse = ", ")
  ),
  AIC = c(
    AIC(forwardAIC), AIC(backwardAIC), AIC(forwardBIC), AIC(backwardBIC)
  ),
  BIC = c(
    BIC(forwardAIC), BIC(backwardAIC), BIC(forwardBIC), BIC(backwardBIC)
  )
)

# Create HTML table
model_summary %>%
  kable("html", caption = "Summary of Variable Selection Methods and Results") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(2, width = "40em")  # Adjust width for the Variables_Selected column
```

